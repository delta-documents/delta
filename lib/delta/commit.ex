defmodule Delta.Commit do
  @moduledoc """
  Internal API for working with commits
  """

  @typedoc """
  Represents a commit made by user to a document.

  ## Fields
    - `:id` – UUIDv4 in default form. **Required**
    - `:previous_commit_id` – UUIDv4 in default form. Used to order commits of particular document to form a history. **Required**
    - `:document_id` – UUIDv4 in default from. **Required**
    - `:order` – Order of commit in document's history. *Autogenerated*
    - `:autosquash?` – Should the commits be squashed with the last change with `:delta` with same paths
    - `:delta` – Changes to document in RFC 6092 Json delta format. **Required**
    - `:reverse_delta` – Json delta to revert document to previous state. Autogenerated
    - `:meta` – any metadata, e. g. user who made it
    - `:updated_at` – when the commit was updated.
  """
  @type t :: %__MODULE__{
          id: Delta.uuid4(),
          previous_commit_id: Delta.uuid4(),
          document_id: Delta.uuid4(),
          order: non_neg_integer,
          autosquash?: boolean,
          delta: rfc_6092 :: any,
          reverse_delta: rfc_6092 :: any,
          meta: any,
          updated_at: DateTime.t()
        }

  defstruct [
    :id,
    :previous_commit_id,
    :document_id,
    :order,
    :autosquash?,
    :delta,
    :reverse_delta,
    :meta,
    :updated_at
  ]

  @doc """
  Validates commit according to the following rules:

  - `:id` – must be UUIDv4 in default form
  - `:previous_commit_id` – must be UUIDv4 in default form of previous commit or `nil`
  - `:delta` – must be valid RFC 6092 Json delta
  - `:document_id` – must be valid UUIDv4 of document in default form.
  """
  @spec validate(t() | any()) :: {:ok, t()} | {:error, Delta.Errors.Validation.t()}
  def validate(commit), do: nil

  @doc """
  Lists commits of `Delta.Documnent` with `id = document_id`. Expensive operation.
  If document does not exists, returns empty list

  Aborts if document with `id = document_id` does not exist.
  """
  @spec list(Delta.Document.t() | Delta.uuid4()) ::
          {:atomic, [t]} | {:aborted, Delta.Errors.DoesNotExist.t()}

  def list(document_id), do: nil

  @doc """
  Lists commit from newest – `from_commit_id` to oldest – `to_commit_id`.

  Aborts with `%Delta.Errors.DoesNotExist{}` if commit with `id = from_commit_id` or `id = to_commit_id` does not exist.
  """
  @spec list(t() | Delta.uuid4(), t() | Delta.uuid4()) ::
          {:atomic, [t]} | {:aborted, Delta.Errors.DoesNotExist.t()}

  def list(from_commit_id, to_commit_id), do: nil

  @spec get(t() | Delta.uuid4()) :: {:atomic, t} | {:aborted, Delta.Errors.DoesNotExist.t()}
  def get(commit_id), do: nil

  @doc """
  Creates commit.

  Aborts with `%Delta.Errors.DoesNotExist{}` if
  commit with `id = commit.previous_commit_id`
  or document with `id = commit.document_id` does not exist.

  Aborts with `%Delta.Errors.AlreadyExists{}` if commit with `id = commit.id` already exists.
  """
  @spec create(t() | Delta.uuid4()) ::
          {:atomic, t} | {:aborted, Delta.Errors.DoesNotExist.t() | Delta.Errors.AlreadyExist.t()}

  def create(commit), do: nil

  @doc """
  Updates commit.

  Aborts with `%Delta.Errors.DoesNotExist{}` if
  commit with `id = commit.previous_commit_id`
  or document with `id = commit.document_id`
  or commit with `id = commit.id` does not exist.
  """
  @spec update(t() | Delta.uuid4()) :: {:atomic, t} | {:aborted, Delta.Errors.DoesNotExist.t()}
  def update(commit, attrs \\ []), do: nil

  @doc """
  Squashes Delta.Commit with `id = commit_id_2` into one with `id = commit_id_1`.
  Resulting commit will have metadata of the second commit.

  Aborts with `%Delta.Errors.DoesNotExist{}` if commit with `id = commit_id_1` or `id = commit_id_2` does not exist.
  """
  @spec squash(t() | Delta.uuid4(), t | Delta.uuid4()) ::
          {:atomic, t} | {:aborted, Delta.Errors.DoesNotExist.t()}
  def squash(commit_id_1, commit_id_2), do: nil

  @doc """
  Deletes commit with `id = commit_id`.
  Returns {:atomic, :ok} even if commit with `id = commit_id` does not exist.
  """
  @spec delete(t() | Delta.uuid4()) :: {:atomic, :ok}
  def delete(change_id), do: nil
end
